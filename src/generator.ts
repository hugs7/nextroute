/**
 * Code generator for route files
 */

import { Project, VariableDeclarationKind, WriterFunction, Writers } from "ts-morph";
import prettier from "prettier";

import { defaultConfig } from "./config";
import { PACKAGE_NAME, PRETTIER_DEFAULT_CONFIG } from "./constants";
import { camelCase, pascalCase, wrapDoubleQuotes } from "./string";
import { RouteConfig, RouteNode } from "./types";

/**
 * Convert RouteNode structure to ts-morph object literal writer
 */
const createObjectWriter = (structure: RouteNode): WriterFunction => {
  return Writers.object(
    Object.entries(structure)
      .sort(([a], [b]) => {
        // Sort to put $param and $route first
        const aOrder = a.startsWith("$") ? 0 : 1;
        const bOrder = b.startsWith("$") ? 0 : 1;
        return aOrder - bOrder;
      })
      .reduce(
        (acc, [key, value]) => {
          // Check if key needs to be quoted (contains special characters)
          const needsQuotes = /[^a-zA-Z0-9_$]/.test(key);
          const safeKey = needsQuotes ? wrapDoubleQuotes(key) : key;

          switch (typeof value) {
            case "object":
              if (value !== null) {
                acc[safeKey] = createObjectWriter(value);
              }
              break;
            case "string":
              acc[safeKey] = wrapDoubleQuotes(value);
              break;
            case "boolean":
            case "number":
            default:
              acc[safeKey] = String(value);
              break;
          }

          return acc;
        },
        {} as Record<string, string | WriterFunction>,
      ),
  );
};

/**
 * Generate complete route file content using ts-morph
 */
export const generateRouteFile = async (structure: RouteNode, config: RouteConfig): Promise<string> => {
  const basePrefix = config.basePrefix ?? "";
  const routesName = config.routesName ?? defaultConfig.routesName;
  const compiledRoutesName = routesName.toUpperCase();
  const typeName = pascalCase(routesName);
  const structureName = [camelCase(typeName), "Structure"].join("");
  const paramTypeMapType = config.paramTypeMap ? config.paramTypeMap.type : "{}";

  // Create in-memory TypeScript project
  const project = new Project({ useInMemoryFileSystem: true });
  const sourceFile = project.createSourceFile("routes.ts");

  // Add runtime imports
  sourceFile.addImportDeclaration({
    moduleSpecifier: PACKAGE_NAME,
    namedImports: ["createRouteBuilder", "RouteBuilderObject"],
  });

  // Add paramTypeMap import if configured
  if (config.paramTypeMap) {
    sourceFile.addImportDeclaration({
      moduleSpecifier: config.paramTypeMap.from,
      namedImports: [{ name: config.paramTypeMap.type, isTypeOnly: true }],
    });
  }

  // Add custom imports if provided
  if (config.imports && config.imports.length > 0) {
    for (const customImport of config.imports) {
      sourceFile.addStatements(customImport);
    }
  }

  // Add route structure constant
  sourceFile.addVariableStatement({
    leadingTrivia: "// Route structure definition\n",
    declarationKind: VariableDeclarationKind.Const,
    declarations: [
      {
        name: structureName,
        initializer: (writer) => {
          createObjectWriter(structure)(writer);
          writer.write(" as const");
        },
      },
    ],
  });

  // Add type export
  sourceFile.addTypeAlias({
    leadingTrivia: "\n// Type-safe route builder with parameter types\n",
    isExported: true,
    name: typeName,
    type: `RouteBuilderObject<typeof ${structureName}, ${paramTypeMapType}>`,
  });

  // Add route builder instance
  sourceFile.addVariableStatement({
    leadingTrivia: "\n// Route builder instance\n",
    isExported: true,
    declarationKind: VariableDeclarationKind.Const,
    declarations: [
      {
        name: compiledRoutesName,
        initializer: `createRouteBuilder<typeof ${structureName}, ${paramTypeMapType}>(${structureName}, [], "${basePrefix}")`,
      },
    ],
  });

  const code = sourceFile.getFullText();

  // Load prettier config from the consuming project, fallback to defaults
  const prettierConfig = (await prettier.resolveConfig(config.output)) || PRETTIER_DEFAULT_CONFIG;

  // Add header comment and format with prettier
  const formattedCode = await prettier.format(code, {
    ...prettierConfig,
    parser: "typescript",
  });

  const header = `/**
 * Auto-generated Next.js route builder
 * Generated from: ${config.input}
 *
 * DO NOT EDIT THIS FILE MANUALLY - it will be regenerated
 */

`;

  return header + formattedCode;
};
